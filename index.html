<!DOCTYPE html>
<html lang="ar" dir="rtl">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>جدول شفتات التمريض</title>
    <!--
      صفحة تفاعلية لعرض جدول الشفتات مباشرة من Google Sheets.
      يقوم الموقع بتحميل بيانات الورقة حسب اسم الورقة الموجود فى القائمة الجانبية.
      يتم تحديث الجدول والألوان تلقائياً وفق التعديلات فى Google Sheets.
      يمكن للمدير تعديل ألوان الرموز وحفظها من خلال زر "تأكيد الألوان".
    -->
    <style>
      body {
        font-family: system-ui, sans-serif;
        margin: 0;
        padding: 0;
        background-color: #f8f9fa;
      }
      .container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 20px;
      }
      h1 {
        font-size: 24px;
        margin-bottom: 16px;
        color: #374151;
      }
      /* تخطيط مرن: الشريط الجانبى على اليمين والمحتوى على اليسار (فى اتجاه RTL) */
      .main-container {
        display: flex;
        flex-direction: row-reverse;
        gap: 20px;
      }
      .sidebar {
        width: 200px;
        background-color: #ffffff;
        border: 1px solid #e5e7eb;
        border-radius: 4px;
        padding: 12px;
        box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
      }
      .sidebar ul {
        list-style: none;
        padding: 0;
        margin: 0;
      }
      .sidebar li {
        padding: 8px 8px;
        cursor: pointer;
        border-bottom: 1px solid #f3f4f6;
        color: #374151;
        font-size: 14px;
      }
      .sidebar li:last-child {
        border-bottom: none;
      }
      .sidebar li.active {
        background-color: #e0f2fe;
        font-weight: bold;
      }
      .sidebar li:hover {
        background-color: #f3f4f6;
      }
      .content-area {
        flex: 1;
      }
      .legend {
        display: flex;
        flex-wrap: wrap;
        gap: 12px;
        margin-top: 8px;
      }
      .legend-item {
        display: flex;
        align-items: center;
        gap: 4px;
        font-size: 13px;
        color: #374151;
        background: #ffffff;
        border: 1px solid #e5e7eb;
        padding: 4px 8px;
        border-radius: 4px;
      }
      .legend-color {
        width: 16px;
        height: 16px;
        border-radius: 3px;
        border: 1px solid #ccc;
      }
      table {
        width: 100%;
        border-collapse: collapse;
        background-color: #ffffff;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
      }
      th,
      td {
        padding: 8px 12px;
        border-bottom: 1px solid #f3f4f6;
        text-align: center;
        vertical-align: middle;
        white-space: pre;
        font-size: 14px;
      }
      th {
        position: sticky;
        top: 0;
        background-color: #f9fafb;
        font-weight: 600;
        color: #374151;
        z-index: 1;
      }
      tbody tr:nth-child(even) {
        background-color: #f9fafb;
      }
      .error {
        background-color: #fee2e2;
        color: #b91c1c;
        padding: 8px;
        border-radius: 4px;
        margin-bottom: 12px;
        font-size: 14px;
      }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  </head>
  <body>
    <div class="container">
      <h1>جدول شفتات التمريض</h1>
      <div class="main-container">
        <div class="sidebar" id="sidebar"></div>
        <div class="content-area">
          <div id="errorContainer"></div>
          <div class="legend" id="legendContainer"></div>
          <div id="tableContainer" style="overflow-x: auto;"></div>
          <!-- يظهر زر التأكيد فقط فى وضع الإدارة -->
          <button id="confirmColorsBtn" style="margin-top: 12px;">تأكيد الألوان</button>
        </div>
      </div>
    </div>
    <script>
      // مفتاح الإدارة: غيّر هذه القيمة لتحديد كلمة سر لوحة التحكم
      const ADMIN_KEY = "admin123";
      // قراءة معاملات سطر العنوان
      const params = new URLSearchParams(window.location.search);
      const isAdmin = params.get("admin") === ADMIN_KEY;

      // معرّف Google Sheets (استبدله بمعرف الملف الحقيقى)
      const GOOGLE_SHEET_ID = "1A5hwXmy2223rY9OSp9sJRCFBIkKaKM21DOggDdKqCCU";
      /*
        قائمة الأوراق التى تمثل جداول الشهور أو الأسابيع.
        كل عنصر يحتوى على اسم الورقة فى Google Sheets (sheet)
        والتسمية التى ستظهر فى القائمة الجانبية (label).
        يرجى تعديل هذه القائمة لتطابق أوراقك الفعلية.
      */
      const SHEET_INFO = [
        { sheet: "January", label: "January" },
        { sheet: "February", label: "February" }
        { sheet: "March", label: "March" }
        { sheet: "April", label: "April" }
        { sheet: "May", label: "May" }
        { sheet: "June", label: "June" }
        { sheet: "July", label: "July" }
        { sheet: "August", label: "August" }
        { sheet: "September", label: "September" }
        { sheet: "October", label: "October" }
        { sheet: "November", label: "November" }
        { sheet: "December", label: "December" }

        // يمكنك إضافة المزيد من الأوراق هنا
      ];

      // استخراج اسم الورقة من معامل "sheet" إذا وُجد
      let currentSheet = SHEET_INFO[0].sheet;
      const sheetParam = params.get("sheet");
      if (sheetParam) {
        try {
          currentSheet = decodeURIComponent(sheetParam);
        } catch (e) {
          currentSheet = sheetParam;
        }
      }

      // تسميات الرموز
      const SHIFT_LABELS = {
        M: "صباحي",
        A: "مسائي",
        N: "ليلي",
        O: "إجازة",
        AL: "سنوية",
        SL: "مرضي",
      };

      // تعريف ألوان الرموز. يمكن تعديلها فى لوحة الإدارة.
      const SHIFT_COLORS = {
        M: { bg: "#fff3cd", fg: "#664d03", strike: false, bold: false },
        A: { bg: "#cfe2ff", fg: "#084298", strike: false, bold: false },
        N: { bg: "#e2d5f8", fg: "#581c87", strike: false, bold: false },
        O: { bg: "#e2e3e5", fg: "#495057", strike: true, bold: false },
        AL: { bg: "#d1e7dd", fg: "#0f5132", strike: false, bold: true },
        SL: { bg: "#f8d7da", fg: "#842029", strike: false, bold: true },
      };

      // إذا تم تمرير ألوان فى معامل "colors"، نطبقها على الكائن
      const colorsParam = params.get("colors");
      (function applyColorsFromParam() {
        if (!colorsParam) return;
        try {
          const decoded = decodeURIComponent(colorsParam);
          const pairs = decoded.split("|");
          pairs.forEach((pair) => {
            const [code, color] = pair.split("-");
            if (code && color && SHIFT_COLORS[code]) {
              SHIFT_COLORS[code].bg = `#${color.replace(/^#/, "")}`;
              SHIFT_COLORS[code].fg = getContrastColor(SHIFT_COLORS[code].bg);
            }
          });
        } catch (e) {
          /* تجاهل أى أخطاء فى التحليل */
        }
      })();

      // تحويل HEX إلى RGB
      function hexToRgb(hex) {
        const clean = hex.replace("#", "");
        const bigint = parseInt(clean, 16);
        const r = (bigint >> 16) & 255;
        const g = (bigint >> 8) & 255;
        const b = bigint & 255;
        return { r, g, b };
      }
      // اختيار لون النص (أسود أو أبيض) بناءً على خلفية الخلية
      function getContrastColor(hex) {
        const { r, g, b } = hexToRgb(hex);
        const Y = (0.2126 * r + 0.7152 * g + 0.0722 * b) / 255;
        return Y > 0.6 ? "#000000" : "#ffffff";
      }
      // تهيئة ألوان النص عند البداية
      (function initTextColors() {
        Object.keys(SHIFT_COLORS).forEach((code) => {
          const bg = SHIFT_COLORS[code].bg;
          SHIFT_COLORS[code].fg = getContrastColor(bg);
        });
      })();

      // تخزين عناصر الرأس والمعطيات
      let metaHeaders = [];
      let dateHeaders = [];
      let dataRows = [];

      function showError(msg) {
        const errorContainer = document.getElementById("errorContainer");
        errorContainer.innerHTML = `<div class="error">${msg}</div>`;
      }
      function clearError() {
        document.getElementById("errorContainer").innerHTML = "";
      }

      // بناء رابط CSV للورقة المعطاة (باستخدام واجهة gviz)
      function buildCsvUrl(sheetName) {
        const encoded = encodeURIComponent(sheetName);
        return `https://docs.google.com/spreadsheets/d/${GOOGLE_SHEET_ID}/gviz/tq?tqx=out:csv&sheet=${encoded}`;
      }

      // رسم القائمة الجانبية
      function renderSidebar() {
        const sidebar = document.getElementById("sidebar");
        if (!sidebar) return;
        const ul = document.createElement("ul");
        SHEET_INFO.forEach((info) => {
          const li = document.createElement("li");
          li.textContent = info.label;
          li.dataset.sheet = info.sheet;
          if (info.sheet === currentSheet) {
            li.classList.add("active");
          }
          li.addEventListener("click", () => {
            loadSheet(info.sheet);
          });
          ul.appendChild(li);
        });
        sidebar.innerHTML = "";
        sidebar.appendChild(ul);
      }

      // التعرف إذا كان رأس العمود يمثل تاريخ
      function isDateHeader(h) {
        return /\b\d{4}-\d{2}-\d{2}\b/.test(h);
      }

      // رسم الجدول
      function renderTable() {
        const container = document.getElementById("tableContainer");
        if (!dataRows || dataRows.length === 0) {
          container.innerHTML = "";
          return;
        }
        let html = "<table><thead><tr>";
        metaHeaders.forEach((h) => {
          html += `<th>${h}</th>`;
        });
        dateHeaders.forEach((h) => {
          html += `<th>${h}</th>`;
        });
        html += "</tr></thead><tbody>";
        dataRows.forEach((row) => {
          html += "<tr>";
          metaHeaders.forEach((h) => {
            html += `<td>${row[h] || ""}</td>`;
          });
          dateHeaders.forEach((h) => {
            const val = (row[h] || "").toString().trim();
            const code = val.toUpperCase();
            const color = SHIFT_COLORS[code];
            if (!val) {
              html += `<td></td>`;
            } else if (color) {
              const style = `background-color: ${color.bg}; color: ${color.fg};${color.strike ? ' text-decoration: line-through;' : ''}${color.bold ? ' font-weight: bold;' : ''}`;
              html += `<td style="${style}">${val}</td>`;
            } else {
              html += `<td>${val}</td>`;
            }
          });
          html += "</tr>";
        });
        html += "</tbody></table>";
        container.innerHTML = html;
      }

      // تحميل بيانات الورقة من Google Sheets
      function loadSheet(sheetName) {
        currentSheet = sheetName;
        renderSidebar();
        clearError();
        const url = buildCsvUrl(sheetName);
        fetch(url)
          .then((res) => {
            if (!res.ok) throw new Error("تعذر جلب الملف: " + res.status);
            return res.text();
          })
          .then((text) => {
            const parsed = Papa.parse(text, {
              header: true,
              skipEmptyLines: true,
            });
            const rows = parsed.data;
            const headers = (parsed.meta.fields || []).filter((h) => h && h.trim().length > 0);
            metaHeaders = headers.filter((h) => !isDateHeader(h));
            dateHeaders = headers.filter((h) => isDateHeader(h));
            dataRows = rows;
            renderTable();
            // تخزين اسم الورقة فى التخزين المحلى
            try {
              localStorage.setItem("shifts_sheet", sheetName);
            } catch (e) {
              /* تجاهل أية أخطاء */
            }
            // تحديث رابط الصفحة بمعامل sheet
            try {
              const newUrl = new URL(window.location.href);
              newUrl.searchParams.set("sheet", encodeURIComponent(sheetName));
              if (isAdmin) newUrl.searchParams.set("admin", ADMIN_KEY);
              const colorsStr = newUrl.searchParams.get("colors");
              if (colorsStr) newUrl.searchParams.set("colors", colorsStr);
              window.history.replaceState(null, "", newUrl.toString());
            } catch (e) {
              /* تجاهل */
            }
          })
          .catch((err) => {
            showError(err.message || "حدث خطأ غير متوقع.");
          });
      }

      // حفظ ألوان الرموز فى التخزين المحلى
      function saveColorsToStorage() {
        try {
          const simple = {};
          Object.keys(SHIFT_COLORS).forEach((code) => {
            const c = SHIFT_COLORS[code];
            simple[code] = { bg: c.bg, strike: !!c.strike, bold: !!c.bold };
          });
          localStorage.setItem("shifts_colors", JSON.stringify(simple));
        } catch (e) {
          /* تجاهل */
        }
      }
      // تحميل ألوان الرموز من التخزين المحلى
      function loadColorsFromStorage() {
        try {
          const stored = localStorage.getItem("shifts_colors");
          if (stored) {
            const parsed = JSON.parse(stored);
            Object.keys(parsed).forEach((code) => {
              if (SHIFT_COLORS[code]) {
                SHIFT_COLORS[code].bg = parsed[code].bg;
                SHIFT_COLORS[code].strike = !!parsed[code].strike;
                SHIFT_COLORS[code].bold = !!parsed[code].bold;
                SHIFT_COLORS[code].fg = getContrastColor(parsed[code].bg);
              }
            });
          }
        } catch (e) {
          /* تجاهل */
        }
      }

      // رسم الأسطورة مع إمكانية تعديل الألوان فى وضع الإدارة
      function renderLegend() {
        const legend = document.getElementById("legendContainer");
        legend.innerHTML = "";
        if (!isAdmin) {
          legend.style.display = "none";
          return;
        }
        legend.style.display = "flex";
        Object.keys(SHIFT_LABELS).forEach((code) => {
          const item = document.createElement("div");
          item.className = "legend-item";
          const colorBox = document.createElement("div");
          colorBox.className = "legend-color";
          colorBox.style.backgroundColor = SHIFT_COLORS[code].bg;
          const label = document.createElement("span");
          label.textContent = `${SHIFT_LABELS[code]} (${code})`;
          item.appendChild(colorBox);
          item.appendChild(label);
          if (isAdmin) {
            const input = document.createElement("input");
            input.type = "color";
            input.value = SHIFT_COLORS[code].bg;
            input.style.marginLeft = "4px";
            input.addEventListener("input", (e) => {
              const newBg = e.target.value;
              SHIFT_COLORS[code].bg = newBg;
              SHIFT_COLORS[code].fg = getContrastColor(newBg);
              colorBox.style.backgroundColor = newBg;
            });
            item.appendChild(input);
          }
          legend.appendChild(item);
        });
      }

      // زر التأكيد يطبق الألوان المخزنة
      (function initConfirmButton() {
        const btn = document.getElementById("confirmColorsBtn");
        if (!btn) return;
        if (!isAdmin) {
          // إخفاء الزر لغير الإدارة
          btn.style.display = "none";
          return;
        }
        btn.addEventListener("click", () => {
          saveColorsToStorage();
          renderLegend();
          renderTable();
          // تحديث معامل colours فى الرابط
          try {
            const newUrl = new URL(window.location.href);
            const colorsString = Object.keys(SHIFT_COLORS)
              .map((code) => {
                const c = SHIFT_COLORS[code];
                return `${code}-${c.bg.replace(/^#/, "")}`;
              })
              .join("|");
            newUrl.searchParams.set("colors", encodeURIComponent(colorsString));
            if (isAdmin) newUrl.searchParams.set("admin", ADMIN_KEY);
            if (currentSheet) newUrl.searchParams.set("sheet", encodeURIComponent(currentSheet));
            window.history.replaceState(null, "", newUrl.toString());
          } catch (e) {
            /* تجاهل */
          }
        });
      })();

      // تهيئة الصفحة عند التحميل
      (function init() {
        try {
          // تحميل ألوان من التخزين إن لم يمرر colours
          if (!colorsParam) {
            loadColorsFromStorage();
          }
          renderLegend();
          renderSidebar();
          // تحميل جدول الورقة الحالية
          loadSheet(currentSheet);
        } catch (e) {
          showError("حدث خطأ أثناء التهيئة.");
        }
      })();
    </script>
  </body>
</html>
